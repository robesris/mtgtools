<!DOCTYPE html>
<html>
<head>
  <title>Commander Game Changers List</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      gap: 20px;
      position: relative;
      width: 100%;
      box-sizing: border-box;
    }
    .color-filter-tray {
      width: 200px;
      min-width: 200px;
      max-width: 200px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 15px;
      position: sticky;
      top: 20px;
      height: fit-content;
      transition: width 0.3s ease, min-width 0.3s ease, max-width 0.3s ease, padding 0.3s ease;
      z-index: 1;
      flex-shrink: 0;
    }
    .color-filter-tray.collapsed {
      width: 30px;
      min-width: 30px;
      max-width: 30px;
      padding: 15px 5px;
    }
    .color-filter-tray .filter-content {
      opacity: 1;
      visibility: visible;
      transition: opacity 0.2s ease, visibility 0.2s, width 0.3s ease;
      width: 100%;
      padding: 5px 0;
      display: flex;
      flex-direction: column;
      gap: 15px;
      min-width: 0;
    }
    .color-filter-tray.collapsed .filter-content {
      opacity: 0;
      visibility: hidden;
      width: 0;
      min-width: 0;
      padding: 0;
    }
    .color-filter-tray .toggle-button {
      position: absolute;
      right: -30px;
      top: 50%;
      transform: translateY(-50%);
      background: white;
      border: none;
      border-radius: 0 4px 4px 0;
      padding: 10px;
      cursor: pointer;
      box-shadow: 2px 0 4px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
      width: 30px;
      height: 30px;
      transition: all 0.3s ease;
      font-size: 0; /* Hide any text content */
    }
    .color-filter-tray.collapsed .toggle-button {
      transform: translateY(-50%);
      right: -30px;
      border-radius: 0 4px 4px 0;
      box-shadow: 2px 0 4px rgba(0,0,0,0.1);
      background: white;
      border: none;
    }
    .color-filter-tray .toggle-button::before {
      content: "‚ñ∂";
      font-size: 12px;
      line-height: 1;
      transition: transform 0.3s ease;
    }
    .color-filter-tray.collapsed .toggle-button::before {
      transform: rotate(180deg);
    }
    .color-filter-tray label {
      position: relative;
      display: block;
      cursor: pointer;
      width: 100%;
      height: 32px;  /* Fixed height */
      margin: 0;  /* Remove margin */
      padding: 0;  /* Remove padding */
      border-radius: 4px;
      transition: background-color 0.2s;
      box-sizing: border-box;
      overflow: hidden;  /* Prevent content from affecting layout */
    }
    .color-filter-tray label:last-child {
      margin: 0;
    }
    .color-filter-tray label:hover {
      background-color: #f5f5f5;
    }
    .color-filter-tray label input[type="checkbox"] {
      position: absolute;
      left: 5px;
      top: 50%;
      transform: translateY(-50%);
      margin: 0;
      width: 16px;
      height: 16px;
      z-index: 2;
      pointer-events: auto;
    }
    .color-filter-tray label span:not(.only-icon) {
      position: absolute;
      left: 29px;  /* checkbox width + padding */
      right: 29px;  /* eye icon width + padding */
      top: 50%;
      transform: translateY(-50%);
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      z-index: 1;
      pointer-events: none;  /* Prevent text from interfering with clicks */
      padding: 2px 8px;
      border-radius: 4px;
    }
    /* Color-specific styles for filter labels */
    .color-filter-tray label[data-color="White"] span:not(.only-icon) {
      background: #F8F8F8;
      color: #333;
      border: 1px solid #ddd;
    }
    .color-filter-tray label[data-color="Blue"] span:not(.only-icon) {
      background: #0070BA;
      color: #fff;
    }
    .color-filter-tray label[data-color="Black"] span:not(.only-icon) {
      background: #150B00;
      color: #fff;
    }
    .color-filter-tray label[data-color="Red"] span:not(.only-icon) {
      background: #D3202A;
      color: #fff;
    }
    .color-filter-tray label[data-color="Green"] span:not(.only-icon) {
      background: #00733E;
      color: #fff;
    }
    .color-filter-tray label[data-color="Multicolor"] span:not(.only-icon) {
      background: linear-gradient(90deg, #0070BA 0%, #D3202A 50%, #00733E 100%);
      color: #fff;
    }
    .color-filter-tray label[data-color="Colorless"] span:not(.only-icon) {
      background: #e0e0e0;
      color: #333;
    }
    .color-filter-tray label[data-color="all"] span:not(.only-icon) {
      background: none;
      color: #333;
      border: none;
      padding: 2px 8px;
    }
    .color-filter-tray .only-icon {
      position: absolute;
      right: 5px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s;
      width: 20px;
      height: 20px;  /* Fixed height */
      line-height: 20px;  /* Center the eye icon vertically */
      text-align: center;
      z-index: 2;
      pointer-events: auto;
      user-select: none;  /* Prevent text selection */
      -webkit-user-select: none;
    }
    .color-filter-tray .only-icon:hover {
      opacity: 1;
    }
    .card-grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 20px;
      margin-top: 20px;
      margin-left: 20px; /* Increased from 10px to 20px to prevent overlap */
      align-items: start;
      width: 100%;
      box-sizing: border-box;
      min-width: 0;
    }
    .card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      transition: transform 0.2s, opacity 0.3s, visibility 0.3s;
      width: 100%;
      box-sizing: border-box;
      min-width: 0;
      opacity: 1;
      visibility: visible;
    }
    .card.hidden-by-color {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      position: absolute;
    }
    .card.hidden-by-all {
      display: none;
    }
    .card:hover {
      transform: translateY(-5px);
    }
    .card-image-container {
      width: 100%;
      position: relative;
      padding-top: 139.7%; /* Magic card aspect ratio (3.5:2.5) */
    }
    .card img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    .card-name {
      font-weight: bold;
      color: #333;
      font-size: 1.1em;
      margin: 10px 0;
      padding: 0 5px;
      width: 100%;
      box-sizing: border-box;
    }
    .price-info {
      margin-top: 10px;
      font-size: 0.9em;
      color: #666;
      width: 100%;
      text-align: left;
      padding: 0 5px;
    }
    .price-info a {
      color: #0066cc;
      text-decoration: none;
    }
    .price-info a:hover {
      text-decoration: underline;
    }
    /* Make timestamp styling more specific and forceful */
    .price-info .price-timestamp {
      display: block;
      font-size: 0.65em !important;
      margin-top: 4px;
      font-style: italic;
      line-height: 1.2;
      color: #666;
    }
    .price-info .price-timestamp.recent {
      color: #2ecc71 !important;
    }
    .price-info .price-timestamp.old {
      color: #e67e22 !important;
    }
    .price-info .price-timestamp.very-old {
      color: #e74c3c !important;
    }
    .loading {
      color: #999;
      font-style: italic;
    }
    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 30px;
      padding: 0 20px;
    }
    .source {
      text-align: center;
      margin-top: 30px;
      color: #666;
      font-size: 0.9em;
      padding: 0 20px;
    }
    .not-found {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #666;
      font-style: italic;
      padding: 15px;
      background: #f8f8f8;
      border-radius: 4px;
      width: 80%;
      text-align: center;
    }
    @media (max-width: 1400px) {
      .card-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));  /* 3 columns on medium screens */
      }
    }
    @media (max-width: 1000px) {
      .card-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));  /* 2 columns on smaller screens */
      }
    }
    @media (max-width: 600px) {
      .card-grid {
        grid-template-columns: repeat(1, minmax(0, 1fr));  /* 1 column on mobile */
      }
      .card {
        padding: 10px;
      }
      .card-name {
        font-size: 1em;
      }
    }
    .card-image-link {
      display: block;
      width: 100%;
      text-decoration: none;
      cursor: pointer;
    }
    .card-image-link:hover img {
      transform: scale(1.05);
      transition: transform 0.2s ease;
    }
    .card-image-container {
      width: 100%;
      position: relative;
      padding-top: 139.7%; /* Magic card aspect ratio (3.5:2.5) */
      overflow: hidden;
    }
    .card img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      transition: transform 0.2s ease;
    }
  </style>
  <script src="card_prices.js"></script>
</head>
<body>
  <div class="container">
    <div class="color-filter-tray">
      <button class="toggle-button" title="Toggle filter tray"></button>
      <div class="filter-content">
        <label data-color="all"><input type="checkbox" data-color="all" checked /><span>ALL</span></label>
        <label data-color="White"><input type="checkbox" data-color="White" checked /><span>White</span><span class="only-icon" data-color="White" title="Show only White cards">üëÅÔ∏è</span></label>
        <label data-color="Blue"><input type="checkbox" data-color="Blue" checked /><span>Blue</span><span class="only-icon" data-color="Blue" title="Show only Blue cards">üëÅÔ∏è</span></label>
        <label data-color="Black"><input type="checkbox" data-color="Black" checked /><span>Black</span><span class="only-icon" data-color="Black" title="Show only Black cards">üëÅÔ∏è</span></label>
        <label data-color="Red"><input type="checkbox" data-color="Red" checked /><span>Red</span><span class="only-icon" data-color="Red" title="Show only Red cards">üëÅÔ∏è</span></label>
        <label data-color="Green"><input type="checkbox" data-color="Green" checked /><span>Green</span><span class="only-icon" data-color="Green" title="Show only Green cards">üëÅÔ∏è</span></label>
        <label data-color="Multicolor"><input type="checkbox" data-color="Multicolor" checked /><span>Multicolor</span><span class="only-icon" data-color="Multicolor" title="Show only Multicolor cards">üëÅÔ∏è</span></label>
        <label data-color="Colorless"><input type="checkbox" data-color="Colorless" checked /><span>Colorless</span><span class="only-icon" data-color="Colorless" title="Show only Colorless cards">üëÅÔ∏è</span></label>
      </div>
    </div>
    <div>
      <h1>Commander Game Changers List</h1>
      <div style="text-align: center; margin: -20px 0 20px; color: #666; font-size: 0.9em; max-width: 800px; margin-left: auto; margin-right: auto; line-height: 1.4;">
        Click a card to go to its Gatherer page.<br>
        Click the space underneath a card to load prices. Note that this process can take a minute or more.
      </div>
      <div style="text-align: center; margin-bottom: 20px;">
        <button id="fetch-all-prices" style="padding: 10px 20px; font-size: 16px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s;">Fetch All Prices</button>
        <div id="fetch-status" style="margin-top: 10px; font-style: italic; color: #666;"></div>
      </div>
      <div class="card-grid">
<div class="card" data-colors="white">
  <div class="card-name">DRANNITH MAGISTRATE</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=479531" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/479531.jpg" alt="DRANNITH MAGISTRATE">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="white">
  <div class="card-name">ENLIGHTENED TUTOR</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=598880" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/598880.jpg" alt="ENLIGHTENED TUTOR">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="white">
  <div class="card-name">HUMILITY</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=397614" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/397614.jpg" alt="HUMILITY">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="colorless">
  <div class="card-name">SERRA'S SANCTUM</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=9674" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/9674.jpg" alt="SERRA'S SANCTUM">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="white">
  <div class="card-name">SMOTHERING TITHE</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=632392" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/632392.jpg" alt="SMOTHERING TITHE">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="white">
  <div class="card-name">TEFERI'S PROTECTION</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=571365" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/571365.jpg" alt="TEFERI'S PROTECTION">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="blue">
  <div class="card-name">CYCLONIC RIFT</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=645410" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/645410.jpg" alt="CYCLONIC RIFT">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="blue">
  <div class="card-name">CONSECRATED SPHINX</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=573395" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/573395.jpg" alt="CONSECRATED SPHINX">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="blue">
  <div class="card-name">EXPROPRIATE</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=677358" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/677358.jpg" alt="EXPROPRIATE">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="blue">
  <div class="card-name">FORCE OF WILL</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=601353" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/601353.jpg" alt="FORCE OF WILL">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="blue">
  <div class="card-name">FIERCE GUARDIANSHIP</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=626344" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/626344.jpg" alt="FIERCE GUARDIANSHIP">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="blue">
  <div class="card-name">GIFTS UNGIVEN</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=571384" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/571384.jpg" alt="GIFTS UNGIVEN">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="blue">
  <div class="card-name">INTUITION</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=397633" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/397633.jpg" alt="INTUITION">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="blue">
  <div class="card-name">JIN-GITAXIAS, CORE AUGUR</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=611316" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/611316.jpg" alt="JIN-GITAXIAS, CORE AUGUR">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="blue">
  <div class="card-name">MYSTICAL TUTOR</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=600972" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/600972.jpg" alt="MYSTICAL TUTOR">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="blue">
  <div class="card-name">NARSET, PARTER OF VEILS</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=677708" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/677708.jpg" alt="NARSET, PARTER OF VEILS">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="blue">
  <div class="card-name">RHYSTIC STUDY</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=632453" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/632453.jpg" alt="RHYSTIC STUDY">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="blue">
  <div class="card-name">SWAY OF THE STARS</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=74034" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/74034.jpg" alt="SWAY OF THE STARS">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="blue">
  <div class="card-name">THASSA'S ORACLE</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=677452" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/677452.jpg" alt="THASSA'S ORACLE">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="blue">
  <div class="card-name">URZA, LORD HIGH ARTIFICER</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=677521" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/677521.jpg" alt="URZA, LORD HIGH ARTIFICER">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="black">
  <div class="card-name">AD NAUSEAM</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=489749" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/489749.jpg" alt="AD NAUSEAM">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="black">
  <div class="card-name">BRAIDS, CABAL MINION</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=526244" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/526244.jpg" alt="BRAIDS, CABAL MINION">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="black">
  <div class="card-name">BOLAS'S CITADEL</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=677715" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/677715.jpg" alt="BOLAS'S CITADEL">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="black">
  <div class="card-name">DEMONIC TUTOR</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=624778" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/624778.jpg" alt="DEMONIC TUTOR">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="black">
  <div class="card-name">IMPERIAL SEAL</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=571412" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/571412.jpg" alt="IMPERIAL SEAL">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="black">
  <div class="card-name">NECROPOTENCE</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=632459" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/632459.jpg" alt="NECROPOTENCE">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="black">
  <div class="card-name">OPPOSITION AGENT</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=497661" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/497661.jpg" alt="OPPOSITION AGENT">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="black">
  <div class="card-name">ORCISH BOWMASTERS</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=616933" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/616933.jpg" alt="ORCISH BOWMASTERS">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="black">
  <div class="card-name">TERGRID, GOD OF FRIGHT</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=507654" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/507654.jpg" alt="TERGRID, GOD OF FRIGHT">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="black">
  <div class="card-name">VAMPIRIC TUTOR</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=598982" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/598982.jpg" alt="VAMPIRIC TUTOR">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="red">
  <div class="card-name">DEFLECTING SWAT</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=626387" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/626387.jpg" alt="DEFLECTING SWAT">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="red">
  <div class="card-name">GAMBLE</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=651682" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/651682.jpg" alt="GAMBLE">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="red">
  <div class="card-name">JESKA'S WILL</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=650250" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/650250.jpg" alt="JESKA'S WILL">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="red">
  <div class="card-name">UNDERWORLD BREACH</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=677477" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/677477.jpg" alt="UNDERWORLD BREACH">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="green">
  <div class="card-name">CROP ROTATION</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=599028" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/599028.jpg" alt="CROP ROTATION">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="green">
  <div class="card-name">FOOD CHAIN</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=571480" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/571480.jpg" alt="FOOD CHAIN">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="colorless">
  <div class="card-name">GAEA'S CRADLE</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=10422" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/10422.jpg" alt="GAEA'S CRADLE">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="green">
  <div class="card-name">NATURAL ORDER</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=677487" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/677487.jpg" alt="NATURAL ORDER">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="green">
  <div class="card-name">SEEDBORN MUSE</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=696424" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/696424.jpg" alt="SEEDBORN MUSE">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="green">
  <div class="card-name">SURVIVAL OF THE FITTEST</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=397535" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/397535.jpg" alt="SURVIVAL OF THE FITTEST">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="green">
  <div class="card-name">VORINCLEX, VOICE OF HUNGER</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=611334" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/611334.jpg" alt="VORINCLEX, VOICE OF HUNGER">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="green">
  <div class="card-name">WORLDLY TUTOR</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=601422" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/601422.jpg" alt="WORLDLY TUTOR">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="multicolor,green,white">
  <div class="card-name">AURA SHARDS</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=247184" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/247184.jpg" alt="AURA SHARDS">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="multicolor,green,white,red,blue,black">
  <div class="card-name">COALITION VICTORY</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=109718" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/109718.jpg" alt="COALITION VICTORY">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="multicolor,blue,green">
  <div class="card-name">KINNAN, BONDER PRODIGY</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=479712" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/479712.jpg" alt="KINNAN, BONDER PRODIGY">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="multicolor,white,blue">
  <div class="card-name">GRAND ARBITER AUGUSTIN IV</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=573469" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/573469.jpg" alt="GRAND ARBITER AUGUSTIN IV">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="multicolor,blue,black">
  <div class="card-name">NOTION THIEF</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=660844" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/660844.jpg" alt="NOTION THIEF">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="multicolor,red,white">
  <div class="card-name">WINOTA, JOINER OF FORCES</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=479736" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/479736.jpg" alt="WINOTA, JOINER OF FORCES">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="multicolor,blue,black">
  <div class="card-name">YURIKO, THE TIGER'S SHADOW</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=629332" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/629332.jpg" alt="YURIKO, THE TIGER'S SHADOW">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="colorless">
  <div class="card-name">ANCIENT TOMB</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=622589" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/622589.jpg" alt="ANCIENT TOMB">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="colorless">
  <div class="card-name">CHROME MOX</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=693158" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/693158.jpg" alt="CHROME MOX">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="colorless">
  <div class="card-name">FIELD OF THE DEAD</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=651686" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/651686.jpg" alt="FIELD OF THE DEAD">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="colorless">
  <div class="card-name">GLACIAL CHASM</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=288996" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/288996.jpg" alt="GLACIAL CHASM">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="colorless">
  <div class="card-name">GRIM MONOLITH</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=12626" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/12626.jpg" alt="GRIM MONOLITH">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="colorless">
  <div class="card-name">LION'S EYE DIAMOND</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=383000" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/383000.jpg" alt="LION'S EYE DIAMOND">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="colorless">
  <div class="card-name">MANA VAULT</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=571641" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/571641.jpg" alt="MANA VAULT">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="colorless">
  <div class="card-name">MOX DIAMOND</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=397482" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/397482.jpg" alt="MOX DIAMOND">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="colorless">
  <div class="card-name">MISHRA'S WORKSHOP</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=383015" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/383015.jpg" alt="MISHRA'S WORKSHOP">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="colorless">
  <div class="card-name">PANOPTIC MIRROR</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=47930" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/47930.jpg" alt="PANOPTIC MIRROR">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="colorless">
  <div class="card-name">THE ONE RING</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=636332" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/636332.jpg" alt="THE ONE RING">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
<div class="card" data-colors="colorless">
  <div class="card-name">THE TABERNACLE AT PENDRELL VALE</div>
  <a href="https://gatherer.wizards.com/Pages/Card/Details.aspx?multiverseid=201236" target="_blank" class="card-image-link">
    <div class="card-image-container">
      <img src="card_images/201236.jpg" alt="THE TABERNACLE AT PENDRELL VALE">
    </div>
  </a>
  <div class="price-info">Click to load prices</div>
</div>
      </div>
      <div class="source">
        Source: <a href="https://magic.wizards.com/en/news/announcements/commander-brackets-beta-update-april-22-2025">Commander Brackets Beta Update - April 22, 2025</a>
      </div>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const tray = document.querySelector('.color-filter-tray');
      const toggleButton = document.querySelector('.toggle-button');
      const allCheckbox = document.querySelector('input[data-color="all"]');
      const colorCheckboxes = document.querySelectorAll('input[data-color]:not([data-color="all"])');
      const onlyIcons = document.querySelectorAll('.only-icon');
      const cards = document.querySelectorAll('.card');
      const fetchAllButton = document.getElementById('fetch-all-prices');
      const fetchStatus = document.getElementById('fetch-status');
      
      // Function to animate ellipsis
      function animateEllipsis(element, text) {
        let dots = 0;
        const maxDots = 3;
        const interval = setInterval(() => {
          dots = (dots + 1) % (maxDots + 1);
          element.innerHTML = `${text}${'.'.repeat(dots)}`;
        }, 500);
        return interval;
      }

      // Function to fetch prices for a single card
      async function fetchCardPrices(cardElement, retryCount = 0) {
        const maxRetries = 3;
        const cardName = cardElement.querySelector('.card-name').textContent;
        const priceInfo = cardElement.querySelector('.price-info');
        
        try {
          priceInfo.innerHTML = '<span class="loading">Fetching prices</span>';
          const ellipsisInterval = animateEllipsis(priceInfo.querySelector('.loading'), 'Fetching prices');
          
          const response = await fetch('/card_info', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ card: cardName })
          });
          clearInterval(ellipsisInterval);
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          
          if (data && data.prices) {
            // Cache the prices immediately after successful fetch
            try {
              await fetch('/cache_prices', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  card: cardName,
                  prices: data.prices,
                  timestamp: data.timestamp || Math.floor(Date.now() / 1000)
                })
              });
            } catch (cacheError) {
              console.warn('Failed to cache prices for', cardName, ':', cacheError);
              // Continue even if caching fails
            }

            let html = [];
            if (data.prices['Near Mint']) {
              const nm = data.prices['Near Mint'];
              html.push(`Near Mint: <a href="${data.tcgplayer_url}" target="_blank">$${parseFloat(nm).toFixed(2)}</a>`);
            }
            if (data.prices['Lightly Played']) {
              const lp = data.prices['Lightly Played'];
              html.push(`Lightly Played: <a href="${data.tcgplayer_url}" target="_blank">$${parseFloat(lp).toFixed(2)}</a>`);
            }
            if (data.timestamp) {
              const timestamp = new Date(data.timestamp * 1000);
              const now = new Date();
              const hoursAgo = Math.floor((now - timestamp) / (1000 * 60 * 60));
              let timestampClass = 'recent';
              if (hoursAgo > 24) {
                timestampClass = hoursAgo > 48 ? 'very-old' : 'old';
              }
              html.push(`<span class="price-timestamp ${timestampClass}">Updated ${hoursAgo} hours ago</span>`);
            }
            priceInfo.innerHTML = html.join(' | ') || 'No prices found';
          } else {
            priceInfo.innerHTML = 'No prices found';
          }
        } catch (error) {
          console.error('Error fetching prices for', cardName, ':', error);
          clearInterval(ellipsisInterval);
          
          // Retry logic for session closure errors
          if (error.message.includes('Session closed') && retryCount < maxRetries) {
            console.log(`Retrying ${cardName} (attempt ${retryCount + 1}/${maxRetries})...`);
            priceInfo.innerHTML = '<span class="loading">Retrying...</span>';
            // Wait before retrying (exponential backoff)
            await new Promise(resolve => setTimeout(resolve, Math.pow(2, retryCount) * 1000));
            return fetchCardPrices(cardElement, retryCount + 1);
          }
          
          priceInfo.innerHTML = 'Click to load prices';
        }
      }
      
      // Function to fetch all prices
      async function fetchAllPrices() {
        if (fetchAllButton.disabled) return; // Prevent multiple clicks
        
        fetchAllButton.disabled = true;
        fetchAllButton.style.backgroundColor = '#999';
        fetchStatus.textContent = 'Fetching prices';
        let ellipsisInterval = animateEllipsis(fetchStatus, 'Fetching prices');
        
        const cardElements = Array.from(cards);
        let completed = 0;
        let failed = 0;
        let retried = 0;
        
        // Process cards in smaller batches to avoid overwhelming the server
        const batchSize = 5;
        for (let i = 0; i < cardElements.length; i += batchSize) {
          const batch = cardElements.slice(i, i + batchSize);
          const batchPromises = batch.map(async (card) => {
            try {
              await fetchCardPrices(card);
              completed++;
            } catch (error) {
              console.error('Error fetching prices for card:', error);
              if (error.message.includes('Session closed')) {
                retried++;
              } else {
                failed++;
              }
            }
          });
          
          // Wait for current batch to complete
          await Promise.all(batchPromises);
          
          // Update status
          clearInterval(ellipsisInterval);
          const status = [
            `Fetched ${completed} cards`,
            failed > 0 ? `${failed} failed` : null,
            retried > 0 ? `${retried} retried` : null
          ].filter(Boolean).join(', ');
          fetchStatus.textContent = status + '...';
          ellipsisInterval = animateEllipsis(fetchStatus, status);
          
          // Add a delay between batches
          await new Promise(resolve => setTimeout(resolve, 2000));
        }
        
        clearInterval(ellipsisInterval);
        const finalStatus = [
          `Completed: ${completed} cards fetched`,
          failed > 0 ? `${failed} failed` : null,
          retried > 0 ? `${retried} retried` : null
        ].filter(Boolean).join(', ');
        fetchStatus.textContent = finalStatus;
        
        fetchAllButton.disabled = false;
        fetchAllButton.style.backgroundColor = '#4CAF50';
      }
      
      // Add click handler for the fetch all button
      fetchAllButton.addEventListener('click', fetchAllPrices);
      
      // Function to update card visibility based on selected colors
      function updateCardVisibility() {
        // First, remove all visibility classes
        cards.forEach(card => {
          card.classList.remove('hidden-by-color');
          card.classList.remove('hidden-by-all');
        });
        
        // If ALL is checked, we're done - all cards are visible
        if (allCheckbox.checked) {
          return;
        }
        
        // Otherwise, apply color filtering
        const selectedColors = Array.from(colorCheckboxes)
          .filter(cb => cb.checked)
          .map(cb => cb.dataset.color.toLowerCase());
        
        cards.forEach(card => {
          const cardColors = card.dataset.colors.split(',');
          // Special handling for Multicolor cards
          const shouldShow = selectedColors.some(color => {
            if (color === 'multicolor') {
              return cardColors.includes('multicolor');
            } else {
              return cardColors.includes(color);
            }
          });
          if (!shouldShow) {
            card.classList.add('hidden-by-color');
          }
        });
      }
      
      // Handle ALL checkbox
      allCheckbox.addEventListener('change', function() {
        // When ALL is checked, remove all visibility classes
        if (this.checked) {
          cards.forEach(card => {
            card.classList.remove('hidden-by-color');
            card.classList.remove('hidden-by-all');
          });
        } else {
          // When ALL is unchecked, update based on color checkboxes
          updateCardVisibility();
        }
      });
      
      // Handle individual color checkboxes
      colorCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          // When any color checkbox changes, uncheck ALL
          allCheckbox.checked = false;
          // Update visibility based on color checkboxes
          updateCardVisibility();
        });
      });
      
      // Handle "only" icons
      onlyIcons.forEach(icon => {
        icon.addEventListener('click', function(e) {
          e.stopPropagation(); // Prevent label click
          const color = this.dataset.color.toLowerCase();
          
          // Uncheck ALL
          allCheckbox.checked = false;
          
          // Uncheck all colors except the clicked one
          colorCheckboxes.forEach(cb => {
            // For Multicolor cards, we need to check if the card has "multicolor" in its colors
            if (color === 'multicolor') {
              cb.checked = cb.dataset.color.toLowerCase() === color;
            } else {
              cb.checked = cb.dataset.color.toLowerCase() === color;
            }
          });
          
          // Update visibility
          updateCardVisibility();
        });
      });
      
      // Toggle tray
      toggleButton.addEventListener('click', function() {
        tray.classList.toggle('collapsed');
      });
      
      // Initial visibility update
      updateCardVisibility();
    });
  </script>
</body>
</html>
